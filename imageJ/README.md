# Hara_et_al
## ImageJ Scripts for counting RAD51 nuclear foci

A series of groovy scripts are used to identify and analyze Rad51 nuclear foci. 
Assumed directory structure is...  
  
ROOT_DIR  
    |___ Cy5  
    |___ DAPI  
    |___ EdU   

Each directory includes original *tiff* images (24-30 images in our cases) corresponding to Cy5(Rad51), DAPI, or EdU channel. 
To run a groovy script, open a groovy script file with *File >> Open* menu in ImageJ (Fiji) software (https://fiji.sc/). A console will show up with the script. Every script requires to manually import an image sequence first (as indicated in "How to use" section at the beginning of each script). To import an image sequence, select *File >> Import >> Image Sequence...* from the menu, and chose a directory where required channel images are stored (e.g. Cy5). Then, click "Run" button in the script console.

### 1. (Optional)"EraseDeltaVisionMetaData.groovy"

Image data generated by DeltaVision Elite microscope software (softWoRx) includes metadata, which can be a source of confusion in the downstream scripting. We erased these metadata to make the image data structures simpler. 

### 2. "Binarization.groovy"

To run this script, you first need to install Mexican Hat Filter plugin (https://imagej.nih.gov/ij/plugins/mexican-hat/index.html) in your Fiji app. This script identifies nuclei using DPAI images. It makes a new directory called **Bin** under the **ROOT_DIR** to save the identified nuclei images. These images are black/white images, where nuclei regions are white (pixle value = 255) and background are black (pixel value = 0). ROI (Region Of Interest) data in the imageJ format is also saved as *RoiSet.zip*. *RoiSet.zip* includes data for positions and shapes of all the identified nuclei.


### 3. "FindRad51Foci.groovy"

This is the main script that implements the algorithms for detecting RAD51 foci.
It uses <i>"Find Maxima"</i> built-in function of ImageJ to identify RAD51 foci within nuclei. The <i>"Find Maxima"</i> function has a parameter called <i>"prominence"</i>, whose value greatly affects the number of identified maxima (i.e. RAD51 foci). The script systematically analyze the number of maxima for various values of the <i>prominence</i> parameter (the analyzed results are saved in *FittingParametersLog.txt*). In general, the number of maxima is a monotonically decreasing function of <i>prominence</i> that can be nicely fit by a power function\*\*\*. A <i>prominence</i> value at which the curvature of the <i>prominence</i>-maxima curve (all nuclei in the image sequence are used to draw the curve) shows the maximum value is heuristically chosen as "the best <i>prominence</i> value". Note that the maximum curvature point can be mathematically derived and computed once the fitting parameters for the power function are determined (implemented in <i>maxCurvature_power()</i> function). The estimated fitting parameters and determined "best" prominece values are saved in *FittingParametersLog.txt*.

\*\*\* Strictly speking, a log-log plot is used for curve fitting.


$$ 
\ln{y} = \ln a + b\ln{x}
$$

, where $y$ is the number of RAD51 foci in a nucleus, and $x$ is prominence.

Curvature $k$ of a curve ( $y=f(x)$ ) is defined as follows.


$$
k=\frac{d^2 y/dx^2}{\sqrt{1+(dy/dx)^2}^3}
$$

By taking derivative of $k$ and setting it to $0$, we obtain (for a power function: $y=a x^b$)


$$
 x=\left(\frac{b-2}{a^2b^2(2b-1)}\right)^{1/(2b-2)}
$$

, where the curvature takes the maximum value. In the script, <i>getMaxCurvature_PowerFunction(log_a, b)</i> function computes the value of $x$.
  
The identified Rad51 foci locations are visualized in black/white images, where a Rad51 focus is represented by a single whitepixel, and stored in *Point* directory.

### 4. "AnalyzeRad51Foci.groovy" 
The main output of the macor is *FociList.txt*, where the following information is stored.
<ul>
  <li>#ROI : ROI ID</li>
  <li>Slice : Slice numbe in an image sequence</li>
  <li>EdU : Mean EdU fluorescence in a nucleus (a.u.)</li>
  <li>X : x-coordinate of a RAD51 focus</li>
  <li>Y : y-coordinate of a RAD51 focus</li>
  <li>Cy5 : max fluorescence intensity (a.u.) of a RAD51 focus</li>
  <li>FociPerCell : the numbe of total RAD51 foci within a nucleus</li>
  <li>Condition : Experimental condition</li>
</ul>

It also generates *SimpleFociList.txt*, a re-organized version of *FociList.txt* to make plotting the data easier. Note that a column called "FociPerCellNoise" is added, where we add a random noise {-0.5, 0, 0.5} to "FociPerCell". These figures are used in jitter plots for better visualization.
